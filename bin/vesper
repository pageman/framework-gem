#!/usr/bin/env ruby
require 'fileutils.rb'
require 'grit'


def show_options
  puts ''
  puts 'Commands:'
  puts ''
  puts '  vesper create app'
  puts '    Summary: Create a new Vesper web app.'
  puts '             Alias for vesper create application.'
  puts '    Example: vesper create app MyApp'
  puts ''
  puts '  vesper install plugin'
  puts '    Summary: Install a plugin from a git repo.'
  puts '             Should be run from inside an existing Vesper app.'
  puts '    Example: vesper install plugin git@github.com:vesper/mobile-request-router.git'
  puts ''
  puts '  vesper remove plugin'
  puts '    Summary: Removes an existing plugin from a Vesper app.'
  puts '    Example: vesper remove plugin mobile-request-router'
  puts ''
  puts '  vesper create plugin'
  puts '    Summary: Creates an empty plugin for development.'
  puts '             Should be run from inside an existing Vesper app.'
  puts '    Example: vesper create plugin my-plugin'
  puts ''
  puts '  vesper run test'
  puts '    Summary: Runs a test using a file in /tests using MiniTest.'
  puts '    Example: vesper run test hello_world'
  puts ''
  puts '  vesper run tests'
  puts '    Summary: Runs tests on all the files in /tests using MiniTest'
  puts '    Example: vesper run tests'
  puts ''
  puts 'Documentation can be found online at: http://vesperapps.com'
  puts ''
  puts 'Questions and comments should be send to: jarrod@vesperapps.com'
  puts ''
end


def create_app app_name
  puts "Creating #{app_name}..."
  FileUtils.cp_r File.dirname(__FILE__) + '/../lib/vesper/framework', app_name unless Dir.exists? app_name
  puts "Bundling gems..."
  system "cd #{app_name} && bundle > /dev/null"
  puts ''
  puts "#{app_name} is ready. Next steps:"
  puts "  cd #{app_name}"
  puts "  rackup"
  puts ''
end


def create_plugin plugin_name
  plugin_name = plugin_name.downcase
  if Dir.exists? "plugins/#{plugin_name}"
    puts ''
    puts "#{plugin_name} is already installed in /plugins."
    puts ''
  else
    puts 'Creating plugin...'    
    FileUtils.cp_r File.dirname(__FILE__) + '/../lib/vesper/plugin', "plugins/#{plugin_name}"
    File.rename "plugins/#{plugin_name}/application/plugin.rb", "plugins/#{plugin_name}/application/#{plugin_name}.rb"
    File.rename "plugins/#{plugin_name}/assets/plugin.rb", "plugins/#{plugin_name}/assets/#{plugin_name}.rb"
    File.rename "plugins/#{plugin_name}/config/plugin.rb", "plugins/#{plugin_name}/config/#{plugin_name}.rb"
    File.rename "plugins/#{plugin_name}/tasks/plugin.rb", "plugins/#{plugin_name}/tasks/#{plugin_name}.rb"
    puts ''
    puts "#{plugin_name} has been installed in /plugins."
    puts 'For more information on Vesper plugin development, visit: http://vesperapps.com'
    puts ''
  end
end


def remove_plugin plugin_name
  if Dir.exists? "plugins/#{plugin_name}"
    FileUtils.rm_rf "plugins/#{plugin_name}"
    puts ''
    puts "#{plugin_name} plugin removed."
    puts ''
  else
    puts ''
    puts 'That plugin isn\'t installed'
    puts ''
  end
end


def install_plugin repo
  puts 'Installing plugin...'
  new_plugin = Grit::Git.new 'tmp/new_plugin'
  new_plugin.clone({:branch => 'master'}, repo, new_plugin.git_dir)
  FileUtils.rm_rf "#{new_plugin.git_dir}/.git"
  require "./#{new_plugin.git_dir}/meta_data.rb"
  FileUtils.mv new_plugin.git_dir, "plugins/#{META_DATA[:name]}"
  puts 'Copying assets...'
  Dir["plugins/#{META_DATA[:name]}/assets/**"].each {|asset| FileUtils.cp_r asset, "./"} 
  puts 'Bundling gems...'
  system "bundle > /dev/null"
  puts ''
  puts "#{META_DATA[:name]} is installed in /plugins."
  puts ''
end


def run_test file
  if File.exists? "./tests/#{file}.rb"
    require 'minitest/autorun'
    require 'vesper'
    require "./tests/#{file}.rb"
  else
    puts ''
    puts 'I can\'t find that test. Maybe there\'s a typ0?'
    puts ''
  end
end


def run_tests
  require 'minitest/autorun'
  require 'vesper'
  Dir["./tests/**/*"].each {|file| require file}
end


ARGV[0] && ARGV[1] ? command = "#{ARGV[0]} #{ARGV[1]}" : command = false
ARGV[2] ? option = ARGV[2] : option = false


case command
when 'create application'
  option ? create_app(option) : show_options
when 'create app'
  option ? create_app(option) : show_options
when 'create plugin'
  option ? create_plugin(option) : show_options
when 'install plugin'
  option ? install_plugin(option) : show_options
when 'remove plugin'
  option ? remove_plugin(option) : show_options
when 'run test'
  option ? run_test(option) : show_options
when 'run tests'
  run_tests
else
  show_options
end